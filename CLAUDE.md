# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Critical Context

This is a **demonstration/educational project only** - NOT for clinical use. The entire codebase was AI-generated by Claude Opus 4.6 for educational purposes. All code includes warnings about not using it for actual medical diagnosis or treatment.

## Project Overview

A comprehensive health risk scoring system based on NHANES 2017-2018 data. Calculates a composite risk score (0-100) from multiple physiological markers across 5 health domains: cardiovascular (30%), metabolic (25%), renal (20%), hepatic (15%), and hematologic (10%).

## Common Commands

### Running Tests
```bash
# IMPORTANT: Always run from project root directory
# Run all tests
pytest tests/

# Run with coverage
pytest tests/ --cov=src --cov-report=html

# Run specific test file
pytest tests/test_risk_models.py

# Run with verbose output
pytest tests/ -v
```

### Running Example Usage
```bash
python example_usage.py
```

### Jupyter Notebooks
```bash
# Start Jupyter server
jupyter notebook

# Key notebooks in notebooks/:
# - 01_data_exploration.ipynb: Data loading, stats, preprocessing
# - 03_risk_model_development.ipynb: Model testing, score calculation
```

### Installing Dependencies
```bash
# Create virtual environment (recommended)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or: venv\Scripts\activate  # Windows

# Install dependencies
pip install -r requirements.txt
```

## Architecture

### Core Design Pattern

The system uses a **weighted composite scoring model** where:
1. **5 domain-specific models** independently calculate risk scores (0-100) based on clinical guidelines
2. **CompositeRiskModel** aggregates domain scores using medical importance weights
3. **Threshold-based classification** maps scores to risk levels with clinical recommendations

### Domain Models (src/models/)

Each domain model follows the same interface:
- `calculate_score(patient_data)` → float (0-100)
- `identify_risk_factors(patient_data)` → List[Dict]
- `generate_recommendations(patient_data, score)` → List[str]

**Domain models:**
- `cardiovascular_risk.py`: LDL, HDL, TC, triglycerides, ratios (30% weight)
- `metabolic_risk.py`: Glucose, HbA1c, HOMA-IR, diabetes assessment (25% weight)
- `renal_risk.py`: eGFR, ACR, CKD staging via KDIGO (20% weight)
- `hepatic_risk.py`: AST, ALT, FIB-4 index, fibrosis risk (15% weight)
- `hematologic_risk.py`: Hemoglobin, WBC, platelets, MCV, anemia classification (10% weight)

**Key implementation detail**: Each model uses threshold-based scoring from `config/clinical_thresholds.yaml`. Scores are calculated by comparing patient values against clinical ranges (optimal/normal/borderline/high) and applying penalties.

### Composite Model Integration

`CompositeRiskModel` in `src/models/composite_risk.py`:
1. Instantiates all 5 domain models in `__init__`
2. Calls each domain's `calculate_score()`
3. Applies weighted sum: `sum(weights[domain] * domain_score)`
4. Applies **age adjustment** (75+: ×1.2, 65+: ×1.1)
5. Applies **multi-domain penalty** (×1.15 if ≥2 domains exceed threshold, default 70, configurable in YAML)
6. Generates alerts for domains ≥60 by calling domain-specific methods
7. Identifies modifiable factors (high LDL, glucose, ALT, etc.)

**Output structure** from `calculate_composite_score()`:
```python
{
    'composite_score': 65.3,           # Overall score 0-100
    'risk_level': 'HIGH',              # OPTIMAL/LOW/MODERATE/HIGH/CRITICAL
    'risk_label': '高リスク',           # Japanese label
    'domain_scores': {...},            # Score for each of 5 domains
    'alerts': [...],                   # High-risk domain warnings
    'modifiable_factors': [...],       # Actionable risk factors
    'recommendations': [...],          # Clinical recommendations
    'age_adjusted_percentile': 85,     # Simplified percentile
    'age_multiplier': 1.1,
    'multi_domain_penalty_applied': True
}
```

**Batch processing**: Use `batch_calculate(df)` to score multiple patients with progress bar (uses tqdm).

### Clinical Thresholds Configuration

`config/clinical_thresholds.yaml` is the **single source of truth** for all clinical cutoffs. Structure:
```yaml
cardiovascular:
  ldl_cholesterol:
    optimal: [0, 100]
    borderline: [130, 159]
    # ...
    guideline: "ACC/AHA 2019"
    variable: "LBDLDL"  # Maps to NHANES variable name
```

When adding new markers:
1. Add threshold ranges to YAML
2. Update the appropriate domain model to read and apply thresholds
3. Update tests to verify scoring logic

### Data Pipeline (src/data/)

- `loader.py`: NHANESLoader - reads CSV files from `data/raw/`
- `preprocessor.py`: NHANESPreprocessor - handles missing values, outliers (Winsorization), data type conversion
- `validator.py`: Data validation utilities

**Important derived features** calculated in preprocessing:
- `eGFR`: CKD-EPI equation for kidney function
- `HOMA_IR`: (insulin × glucose) / 405 for insulin resistance
- `FIB4`: (age × AST) / (platelet × √ALT) for liver fibrosis
- `TC_HDL_ratio`, `LDL_HDL_ratio`, `AST_ALT_ratio`
- `ACR`: urine albumin/creatinine ratio × 1000

### NHANES Variable Naming Convention

Variables follow NHANES naming:
- `SEQN`: Patient ID
- `RIDAGEYR`: Age in years
- `RIAGENDR`: Gender (1=Male, 2=Female)
- `LBX*`: Lab values (e.g., LBDLDL, LBXGLU, LBXHGB)
- `LBD*`: Some specific lab values (e.g., LBDHDD for HDL)

When adding new features, maintain this naming convention or document mappings in clinical_thresholds.yaml.

## Test Structure

Tests in `tests/test_risk_models.py` follow pattern:
- Test each domain model independently with optimal/normal and high-risk profiles
- Test CompositeRiskModel with healthy patient (expected score 0-30) and high-risk patient (expected ≥60)
- Test specific clinical assessments (diabetes status, CKD staging, anemia classification)
- Test age adjustment effects

All 18 tests pass. When modifying models, ensure test cases still reflect clinically realistic scenarios.

## Key Constraints & Considerations

### Medical Validity
- All thresholds sourced from published guidelines (ACC/AHA 2019, ADA 2023, KDIGO 2012, AASLD 2018, WHO)
- Risk weights reflect general medical importance but are **not validated by clinical trials**
- Age adjustments are simplified multipliers, not sophisticated survival models

### Data Limitations
- Based on US NHANES population - may not generalize to other demographics
- Cross-sectional data - cannot assess longitudinal risk
- Missing data is common (some tests only done on subsets)
- System handles missing values via pandas NaN - missing markers are skipped in scoring

### Not Implemented
- No machine learning models (purely rule-based)
- No reporting module implementation (skeleton exists in `src/reporting/`)
- No API or web interface
- No database integration

## Working with This Codebase

### Adding a New Health Domain
1. Create `src/models/new_domain_risk.py` following existing domain model interface
2. Add thresholds to `config/clinical_thresholds.yaml`
3. Instantiate in `CompositeRiskModel.__init__`
4. Add to `domain_scores` calculation with appropriate weight
5. Add alert generation logic in `_generate_alerts`
6. Write tests in `tests/test_risk_models.py`

### Modifying Risk Weights
Edit `risk_weights` section in `config/clinical_thresholds.yaml`. Weights should sum to 1.0.

### Adjusting Risk Level Thresholds
Edit `risk_levels` section in YAML:
```yaml
risk_levels:
  moderate:
    range: [40, 60]
    label: "中リスク"
    severity: "MODERATE"
```

### Understanding Score Calculation Flow
1. User provides patient dict/Series with NHANES variables
2. `CompositeRiskModel.calculate_composite_score()` entry point
3. Each domain model reads thresholds from `self.config` (loaded from YAML)
4. Domain calculates sub-scores for each marker, aggregates
5. Composite model applies weights, age adjustment, penalties
6. Generates structured output with scores, alerts, recommendations

## Common Pitfalls

- **Import errors**: Must run scripts from project root directory (not from src/ or tests/)
- **Missing thresholds**: If adding new markers, must add to YAML or will be skipped silently
- **Unit mismatches**: NHANES uses specific units (mg/dL, g/dL, etc.) - ensure input data matches
- **Gender-specific thresholds**: Some markers (HDL, hemoglobin, AST, ALT) have different cutoffs for males (1) vs females (2)
